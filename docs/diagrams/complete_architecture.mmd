flowchart TB
    %% User Layer
    subgraph Users["üë• USER LAYER"]
        WEB["üåê Web Browser"]
        MOBILE["üì± Mobile App"]
        DESKTOP["üíª Desktop App"]
        PWA["üì≤ Progressive Web App"]
    end

    %% CDN Layer
    subgraph CDN["üåç CONTENT DELIVERY LAYER"]
        AZCDN["Azure CDN<br/>Global Edge Network<br/>Static Assets & Images"]
    end

    %% Security Layer
    subgraph Security["üõ°Ô∏è SECURITY & LOAD BALANCING LAYER"]
        APPGW["Azure Application Gateway + WAF<br/>‚Ä¢ OWASP Top 10 Protection<br/>‚Ä¢ DDoS Protection<br/>‚Ä¢ SSL Offloading"]
    end

    %% API Gateway
    subgraph APIM_Layer["üö¶ API GATEWAY LAYER"]
        APIM["Azure API Management<br/>‚Ä¢ Rate Limiting (100 req/min)<br/>‚Ä¢ JWT Validation<br/>‚Ä¢ Request Logging<br/>‚Ä¢ Response Caching"]
    end

    %% Auth Service
    subgraph Auth["üîê AUTHENTICATION"]
        ADB2C["Azure AD B2C<br/>‚Ä¢ Multi-factor Auth<br/>‚Ä¢ Social Login<br/>‚Ä¢ JWT Tokens"]
    end

    %% Business Logic Layer
    subgraph Business["‚öôÔ∏è BUSINESS LOGIC LAYER"]
        APPSERVICE["Azure App Service<br/>Python 3.11<br/>‚Ä¢ REST API Endpoints<br/>‚Ä¢ WebSocket Server<br/>‚Ä¢ 2-10 Auto-scale Instances"]
        
        FUNCTIONS["Azure Functions<br/>Serverless Background Tasks<br/>‚Ä¢ process-document-async<br/>‚Ä¢ send-notifications<br/>‚Ä¢ cleanup-old-data<br/>‚Ä¢ generate-reports"]
    end

    %% AI Processing Layer
    subgraph AI["ü§ñ AI & ML PROCESSING LAYER"]
        ORCHESTRATOR["Orchestrator Agent<br/>Azure OpenAI GPT-4<br/>‚Ä¢ Query Analysis<br/>‚Ä¢ Agent Routing<br/>‚Ä¢ Context Management"]
        
        DRUGAGENT["Drug Info Agent<br/>BioGPT<br/>‚Ä¢ RAG Query<br/>‚Ä¢ DB Search<br/>‚Ä¢ Response Generation"]
        
        MEDAGENT["Medical Q&A Agent<br/>Med42-Llama3<br/>‚Ä¢ RAG Retrieval<br/>‚Ä¢ Context Analysis<br/>‚Ä¢ Answer Generation"]
        
        RAG["RAG System<br/>Azure AI Search<br/>‚Ä¢ Vector Search (1536D)<br/>‚Ä¢ Cosine Similarity<br/>‚Ä¢ Top-K Retrieval"]
        
        DOCAI["Document Intelligence<br/>‚Ä¢ OCR Extraction<br/>‚Ä¢ Layout Analysis<br/>‚Ä¢ Custom Indian Rx Model"]
        
        BIOMEDCLIP["BiomedCLIP<br/>Image Analysis<br/>Medical Image Processing"]
    end

    %% Data Storage Layer
    subgraph Storage["üíæ DATA STORAGE LAYER"]
        BLOB["Azure Blob Storage<br/>‚Ä¢ Documents & Images<br/>‚Ä¢ PDFs & Uploads<br/>‚Ä¢ Hot Tier, LRS"]
        
        SQLDB["Azure SQL Database<br/>‚Ä¢ Users & Profiles<br/>‚Ä¢ Drug Database<br/>‚Ä¢ Prescriptions<br/>S2 Standard, 250GB"]
        
        COSMOS["Azure Cosmos DB<br/>‚Ä¢ Chat History<br/>‚Ä¢ Conversations<br/>‚Ä¢ Global Distribution<br/>400-4000 RU/s"]
        
        REDIS["Azure Redis Cache<br/>‚Ä¢ Query Results (1h TTL)<br/>‚Ä¢ Drug Info (7d TTL)<br/>‚Ä¢ User Sessions (1h TTL)<br/>‚Ä¢ RAG Results (6h TTL)<br/>Basic C1, 1GB"]
    end

    %% Security Services
    subgraph SecServices["üîí SECURITY SERVICES"]
        KEYVAULT["Azure Key Vault<br/>‚Ä¢ API Keys & Secrets<br/>‚Ä¢ Connection Strings<br/>‚Ä¢ Certificates<br/>‚Ä¢ Auto-rotation<br/>HSM-backed"]
        
        IDENTITY["Managed Identities<br/>‚Ä¢ App Service ‚Üí Key Vault<br/>‚Ä¢ Functions ‚Üí Storage<br/>‚Ä¢ Zero Stored Credentials"]
    end

    %% Monitoring Layer
    subgraph Monitor["üìä MONITORING & OBSERVABILITY"]
        APPINSIGHTS["Application Insights<br/>‚Ä¢ Real-time Metrics<br/>‚Ä¢ Distributed Tracing<br/>‚Ä¢ Custom Events<br/>‚Ä¢ Performance Analysis"]
        
        LOGANALYTICS["Log Analytics Workspace<br/>‚Ä¢ Centralized Logging<br/>‚Ä¢ KQL Queries<br/>‚Ä¢ 90-day Retention"]
        
        AZMONITOR["Azure Monitor<br/>‚Ä¢ Alert Rules<br/>‚Ä¢ Dashboards<br/>‚Ä¢ Cost Analysis<br/>‚Ä¢ Resource Health"]
        
        COMMS["Communication Services<br/>‚Ä¢ Email Notifications<br/>‚Ä¢ SMS Alerts<br/>‚Ä¢ Incident Response"]
    end

    %% Knowledge Sources
    subgraph Knowledge["üìö KNOWLEDGE SOURCES"]
        MEDICAL["Medical Knowledge<br/>‚Ä¢ WHO Guidelines<br/>‚Ä¢ ICMR Advisories<br/>‚Ä¢ Research Papers"]
        
        DRUGDB["Drug Database<br/>‚Ä¢ CDSCO Data<br/>‚Ä¢ Interactions<br/>‚Ä¢ Side Effects"]
        
        USERDOCS["User Documents<br/>‚Ä¢ Prescriptions<br/>‚Ä¢ Medical History"]
    end

    %% Main Flow Connections
    WEB & MOBILE & DESKTOP & PWA -->|HTTPS TLS 1.3| AZCDN
    AZCDN -->|Forwarded| APPGW
    APPGW -->|WAF Filtered| APIM
    APIM -->|Route to| ADB2C & APPSERVICE & FUNCTIONS
    
    %% Business Logic Connections
    APPSERVICE -->|Orchestrate| ORCHESTRATOR
    APPSERVICE -->|Query| SQLDB & COSMOS & REDIS & BLOB
    FUNCTIONS -->|Blob Trigger| BLOB
    FUNCTIONS -->|Process| DOCAI
    
    %% AI Flow
    ORCHESTRATOR -->|Route to| DRUGAGENT & MEDAGENT
    DRUGAGENT & MEDAGENT -->|Retrieve from| RAG
    RAG -->|Search in| MEDICAL & DRUGDB & USERDOCS
    APPSERVICE -->|OCR| DOCAI
    APPSERVICE -->|Image Analysis| BIOMEDCLIP
    
    %% Security Connections
    KEYVAULT -.->|Secure Access| APPSERVICE & FUNCTIONS
    IDENTITY -.->|Authenticate| KEYVAULT
    
    %% Monitoring Connections
    APPSERVICE & FUNCTIONS -->|Telemetry| APPINSIGHTS
    APPINSIGHTS -->|Aggregate| LOGANALYTICS
    LOGANALYTICS -->|Analyze| AZMONITOR
    AZMONITOR -->|Notify| COMMS
    
    %% Cache Flow
    APPSERVICE -->|Check Cache| REDIS
    REDIS -.->|Cache Miss| ORCHESTRATOR
    ORCHESTRATOR -.->|Cache Result| REDIS
    
    %% Document Processing Flow
    BLOB -->|Trigger| FUNCTIONS
    FUNCTIONS -->|Extract| DOCAI
    DOCAI -->|Save to| SQLDB & BLOB
    DOCAI -->|Index in| RAG

    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef securityClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef businessClass fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef aiClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef storageClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef monitorClass fill:#e0f2f1,stroke:#004d40,stroke-width:2px,color:#000
    
    class WEB,MOBILE,DESKTOP,PWA userClass
    class APPGW,ADB2C,KEYVAULT,IDENTITY securityClass
    class APPSERVICE,FUNCTIONS,APIM businessClass
    class ORCHESTRATOR,DRUGAGENT,MEDAGENT,RAG,DOCAI,BIOMEDCLIP aiClass
    class BLOB,SQLDB,COSMOS,REDIS storageClass
    class APPINSIGHTS,LOGANALYTICS,AZMONITOR,COMMS monitorClass

